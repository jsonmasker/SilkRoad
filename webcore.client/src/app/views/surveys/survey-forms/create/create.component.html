<h3>Create Survey form</h3>
<c-card>
    <c-card-body>
        <!-- Survey Form Creation Form -->
        <div class="title">
            <span>1. Survey Information</span>
        </div>
        <form cForm [formGroup]="createForm" (ngSubmit)="onSubmit()">
            <div class="mb-2 row">
                <div class="col-6">
                    <label cLabel for="name">Name: <span class="text-danger">(*)</span></label>
                    <input cFormControl formControlName="name" type="text" />
                    @if (name?.invalid && (name?.dirty || name?.touched)) {
                    <div class="text-danger">
                        @if (name?.hasError('required')) {
                        <div>Enter Name, please!</div>
                        }
                    </div>
                    }
                </div>
                <div class="col-6">
                    <label cLabel>Start - End Date: <span class="text-danger">(*)</span></label>
                    <app-range-datetime-picker></app-range-datetime-picker>
                </div>
            </div>
            <div class="mb-2 row">
                <div class="col-6">
                    <label cLabel for="titleEN">TitleEN: <span class="text-danger">(*)</span></label>
                    <input cFormControl formControlName="titleEN" type="text" />
                    @if (titleEN?.invalid && (titleEN?.dirty || titleEN?.touched)) {
                    <div class="text-danger">
                        @if (titleEN?.hasError('required')) {
                        <div>Enter TitleEN, please!</div>
                        }
                    </div>
                    }
                </div>
                <div class="col-6">
                    <label cLabel for="titleVN">TitleVN: <span class="text-danger">(*)</span></label>
                    <input cFormControl formControlName="titleVN" type="text" />
                    @if (titleVN?.invalid && (titleVN?.dirty || titleVN?.touched)) {
                    <div class="text-danger">
                        @if (titleVN?.hasError('required')) {
                        <div>Enter TitleVN, please!</div>
                        }
                    </div>
                    }
                </div>
            </div>
            <div class="mb-2 row">
                <div class="col-6">
                    <label cLabel for="descriptionEN">DescriptionEN:</label>
                    <textarea cFormControl formControlName="descriptionEN" rows="3"></textarea>
                </div>
                <div class="col-6">
                    <label cLabel for="descriptionVN">DescriptionVN:</label>
                    <textarea cFormControl formControlName="descriptionVN" rows="3"></textarea>
                </div>
            </div>
        </form>
        <!-- Table of Question Groups -->
        <div class="d-flex justify-content-between align-items-center title mt-4">
            <span>2. Question Groups</span>
            <div class="d-flex justify-content-end">
                <button cButton type="button"
                    class="btn-success me-2 text-white d-flex justify-content-center align-items-center">
                    <svg [cIcon]="icons.cilPlus" width="20" class="text-white" title="Plus Icon"></svg>
                </button>
            </div>
        </div>
        <table cTable>
            <thead>
                <tr>
                    <th scope="col">No.</th>
                    <th scope="col">NameEN</th>
                    <th scope="col">NameVN</th>
                    <th scope="col">Priority</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @for(item of questionGroups; track $index; let i = $index) {
                <tr>
                    <th scope="row">{{ i + 1 }}</th>
                    <td>{{ item.nameEN }}</td>
                    <td>{{ item.nameVN }}</td>
                    <td>{{ item.priority }}</td>
                    <td class="text-end">
                        <!-- <button class="btn btn-info me-2">
                            <app-book-icon [open]="item.expanded ?? false" [size]="20"></app-book-icon>
                        </button> -->
                        @if((item?.questions?.length ?? 0) > 0) {
                            <button (click)="toggleQuestionNode(item)" class="btn btn-info me-2">
                                <app-book-icon [open]="item.expanded ?? false" [size]="20"></app-book-icon>
                            </button>
                        }
                        <button cButton (click)="toggleCreateQuestionGroupModal()" type="button" class="btn-success text-white me-2">
                            <svg [cIcon]="icons.cilPlus" width="20" class="text-white" title="Edit Icon"></svg>
                        </button>
                        <button cButton type="button" class="btn-primary text-white me-2">
                            <svg [cIcon]="icons.cilPen" width="20" class="text-white" title="Edit Icon"></svg>
                        </button>
                        <button cButton type="button" (click)="toggleDeleteQuestionGroupModal()" class="btn-danger text-white">
                            <svg [cIcon]="icons.cilTrash" width="20" class="text-white" title="Trash Icon"></svg>
                        </button>
                    </td>
                </tr>
                @if(item.expanded && (item?.questions?.length ?? 0) > 0) {
                    @for(item1 of item.questions; track $index; let j = $index) {
                    <ng-container>
                        <ng-container [ngTemplateOutlet]="questionTemplate"
                            [ngTemplateOutletContext]="{ node: item1, index: j, level: 1 }"></ng-container>
                    </ng-container>
                    }
                }
                }
            </tbody>
        </table>

        <!-- Table of Questions -->

        <div class="d-flex justify-content-between align-items-center title mt-4">
            <span>3. Questions</span>
            <div class="d-flex justify-content-end">
                <button cButton type="button"
                    class="btn-success me-2 text-white d-flex justify-content-center align-items-center">
                    <svg [cIcon]="icons.cilPlus" width="20" class="text-white" title="Plus Icon"></svg>
                </button>
            </div>
        </div>
        <table cTable>
            <thead>
                <tr>
                    <th scope="col">No.</th>
                    <th scope="col">NameEN</th>
                    <th scope="col">NameVN</th>
                    <th scope="col">Priority</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @for(item of questions; track $index; let i = $index) {
                    <ng-container>
                        <ng-container [ngTemplateOutlet]="questionTemplate"
                            [ngTemplateOutletContext]="{ node: item, index: i, level: 0 }"></ng-container>
                    </ng-container>
                }
            </tbody>
        </table>

        <!-- Button Submit Creation Form -->
        <div class="d-flex justify-content-end mt-4">
            <button cButton type="submit" (click)="onSubmit()" [disabled]="!createForm.valid">Submit</button>
            <button cButton type="button" routerLink="/surveys/extend-survey/survey-forms" class="ms-2 btn-info">Back to
                list</button>
        </div>
    </c-card-body>
</c-card>

<ng-template #questionTemplate let-node="node" let-level="level" let-index="index">
    <tr class="tree-row" [class.expanded]="node.expanded" [class.children]="level > 0">
        <th>
            <span [ngStyle]="{'margin-left.px': level * 15}">
                {{ index + 1 }}
            </span>
        </th>
        <td>{{ node.nameEN }}</td>
        <td>{{ node.nameVN }}</td>
        <td>{{ node.priority }}</td>
        <td class="text-end">
            @if((node.predefinedAnswers?.length ?? 0) > 0) {
                <button (click)="togglePredefinedAnswerNode(node)" class="btn btn-info me-2">
                    <app-book-icon [open]="node.expanded ?? false" [size]="20"></app-book-icon>
                </button>
            }
            <button cButton type="button" (click)="toggleCreateQuestionModal()" class="btn-success text-white me-2">
                <svg [cIcon]="icons.cilPlus" width="20" class="text-white" title="Plus Icon"></svg>
            </button>
            <button cButton type="button" class="btn-primary text-white me-2">
                <svg [cIcon]="icons.cilPen" width="20" class="text-white" title="Edit Icon"></svg>
            </button>
            <button cButton type="button" (click)="toggleDeleteQuestionModal()" class="btn-danger text-white">
                <svg [cIcon]="icons.cilTrash" width="20" class="text-white" title="Trash Icon"></svg>
            </button>
        </td>
    </tr>
    @if(node.expanded && (node?.predefinedAnswers?.length ?? 0) > 0) {
        @for(item1 of node.predefinedAnswers; track $index; let j = $index) {
        <ng-container>
            <ng-container [ngTemplateOutlet]="predefinedAnswerTemplate"
                [ngTemplateOutletContext]="{ node: item1, index: j, level: level + 1 }"></ng-container>
        </ng-container>
        }
    }
</ng-template>


<ng-template #predefinedAnswerTemplate let-node="node" let-level="level" let-index="index">
    <tr class="tree-row" [class.expanded]="node.expanded" [class.children]="level > 0">
        <th>
            <span [ngStyle]="{'margin-left.px': level * 15}">
                {{ index + 1 }}
            </span>
        </th>
        <td>{{ node.nameVN }}</td>
        <td>{{ node.nameEN }}</td>
        <td>{{ node.priority }}</td>
        <td>###</td>
    </tr>
</ng-template>

<c-modal id="visibleCreateQuestionGroupModal" [visible]="visibleCreateQuestionGroupModal()" (visibleChange)="handleCreateQuestionGroupModalChange($event)">
  <c-modal-header>
    <h5 cModalTitle>Modal title visibleCreateQuestionGroupModal</h5>
    <button (click)="toggleCreateQuestionGroupModal()" cButtonClose></button>
  </c-modal-header>
  <c-modal-body>Woohoo, you are reading this text in a modal!</c-modal-body>
  <c-modal-footer>
    <button (click)="toggleCreateQuestionGroupModal()" cButton color="secondary">
      Close
    </button>
    <button cButton color="primary">Save changes</button>
  </c-modal-footer>
</c-modal>

<c-modal id="visibleDeleteQuestionGroupModal" [visible]="visibleDeleteQuestionGroupModal()" (visibleChange)="handleDeleteQuestionGroupModalChange($event)">
  <c-modal-header>
    <h5 cModalTitle>Modal title visibleDeleteQuestionGroupModal</h5>
    <button (click)="toggleDeleteQuestionGroupModal()" cButtonClose></button>
  </c-modal-header>
  <c-modal-body>Woohoo, you are reading this text in a modal!</c-modal-body>
  <c-modal-footer>
    <button (click)="toggleDeleteQuestionGroupModal()" cButton color="secondary">
      Close
    </button>
    <button cButton color="primary">Save changes</button>
  </c-modal-footer>
</c-modal>

<c-modal id="visibleCreateQuestionModal" [visible]="visibleCreateQuestionModal()" (visibleChange)="handleCreateQuestionModalChange($event)">
  <c-modal-header>
    <h5 cModalTitle>Modal title visibleCreateQuestionModal</h5>
    <button (click)="toggleCreateQuestionModal()" cButtonClose></button>
  </c-modal-header>
  <c-modal-body>Woohoo, you are reading this text in a modal!</c-modal-body>
  <c-modal-footer>
    <button (click)="toggleCreateQuestionModal()" cButton color="secondary">
      Close
    </button>
    <button cButton color="primary">Save changes</button>
  </c-modal-footer>
</c-modal>

<c-modal id="visibleDeleteQuestionModal" [visible]="visibleDeleteQuestionModal()" (visibleChange)="handleDeleteQuestionModalChange($event)">
  <c-modal-header>
    <h5 cModalTitle>Modal title visibleDeleteQuestionModal</h5>
    <button (click)="toggleDeleteQuestionModal()" cButtonClose></button>
  </c-modal-header>
  <c-modal-body>Woohoo, you are reading this text in a modal!</c-modal-body>
  <c-modal-footer>
    <button (click)="toggleDeleteQuestionModal()" cButton color="secondary">
      Close
    </button>
    <button cButton color="primary">Save changes</button>
  </c-modal-footer>
</c-modal>